#include "glbopts.h"
#include "linalg.h"
#include "minunit.h"
#include "problem_utils.h"
#include "rw.h"
#include "scs.h"
#include "scs_matrix.h"
#include "util.h"

/* Randomly generated problem that mixes psd and complex psd cones */
static const char *sd_and_complex_sd(void) {
  ScsCone *k = (ScsCone *)scs_calloc(1, sizeof(ScsCone));
  ScsData *d = (ScsData *)scs_calloc(1, sizeof(ScsData));
  ScsSettings *stgs = (ScsSettings *)scs_calloc(1, sizeof(ScsSettings));
  ScsSolution *sol = (ScsSolution *)scs_calloc(1, sizeof(ScsSolution));
  ScsInfo info = {0};
  scs_int exitflag;
  scs_float perr, derr;
  scs_int success;
  const char *fail;

  /* data */
  scs_float Px[] = {0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1,
                    0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1,
                    0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1,
                    0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1,
                    0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1};

  scs_int Pi[] = {0,  1,  2,  3,  4,  5,  6,  7,  8,  9,  10, 11, 12, 13, 14,
                  15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29,
                  30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44,
                  45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59};

  scs_int Pp[] = {0,  1,  2,  3,  4,  5,  6,  7,  8,  9,  10, 11, 12,
                  13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25,
                  26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38,
                  39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51,
                  52, 53, 54, 55, 56, 57, 58, 59, 60};

  scs_float Ax[] = {
      0.8, 0.8, 0.5, 0.4, 0.6, 0.1, 0.4, 0.5, 1,   0.6, 0.4, 0.8, 0.8, 0.7,
      0.1, 0.3, 0.3, 0.8, 0.4, 1,   0.2, 0.6, 0.2, 0.9, 0.7, 0.4, 0.6, 0.2,
      0.2, 0.9, 0.1, 0.1, 0.5, 0.7, 0.6, 0.1, 0.2, 0.1, 0.8, 0.3, 0.8, 0.6,
      0.5, 1,   0.4, 0.5, 0.2, 0.5, 0.7, 0.7, 0.3, 0.9, 0.9, 0.5, 0.6, 0.2,
      0.4, 0.8, 0.7, 0.6, 0.1, 0.2, 0.8, 0.2, 0.5, 0.7, 0.1, 0.6, 0.8, 0.6,
      0.1, 0.6, 0.6, 0.1, 0.6, 0.9, 0.7, 0.9, 0.5, 0.1, 0.8, 0.1, 0.4, 0.4,
      0.5, 1,   0.8, 0.1, 0.6, 0,   0.8, 0.2, 0.4, 0.3, 0.6, 0.2, 0.7, 0.2,
      0.9, 0.4, 0.3, 0.5, 0.5, 0.4, 0.5, 0.1, 0.6, 0.6, 0.8, 0.5, 0,   0.5,
      0,   0.6, 0.2, 0.7, 0.7, 0.5, 0.4, 0.7, 0.8, 0.2, 0.9, 0.3, 0.3, 0.9,
      0.6, 0.2, 1,   0.4, 0.6, 0.3, 0.8, 0.8, 0.1, 0.5, 0.4, 0.1, 0.1, 0.6,
      0.2, 0.4, 0.6, 0.8, 0.4, 0.1, 0.6, 0.7, 0.4, 0.9, 0.3, 0.2, 0.4, 0.4,
      0.8, 1,   0.3, 0.7, 0.2, 0.5, 1,   0.3, 0.9, 0.4, 0.9, 0.8, 0.7, 0.4,
      0.5, 1,   0.4, 0.3, 0.6, 1,   0.8, 0.6, 0,   1,   0.6, 0.9};

  scs_int Ai[] = {
      25, 44, 3,  19, 23, 27, 47, 51, 54, 58, 20, 29, 42, 45, 1,  21, 39, 17,
      20, 28, 46, 52, 1,  2,  13, 36, 21, 6,  16, 23, 34, 1,  11, 51, 59, 6,
      7,  8,  15, 30, 39, 47, 22, 7,  12, 30, 31, 38, 48, 29, 39, 56, 19, 24,
      50, 46, 22, 50, 3,  25, 33, 44, 54, 57, 0,  43, 3,  19, 37, 52, 58, 12,
      21, 26, 58, 3,  8,  30, 2,  54, 39, 40, 43, 44, 49, 17, 9,  15, 17, 53,
      59, 14, 0,  5,  5,  44, 48, 58, 14, 15, 48, 31, 29, 40, 41, 42, 6,  53,
      55, 10, 15, 9,  17, 19, 29, 57, 6,  17, 55, 11, 27, 42, 45, 56, 7,  18,
      24, 28, 46, 51, 5,  29, 40, 1,  6,  35, 36, 11, 18, 44, 36, 45, 49, 45,
      56, 57, 0,  7,  25, 42, 48, 0,  10, 25, 43, 47, 58, 3,  11, 30, 40, 43,
      47, 58, 2,  18, 27, 10, 21, 57, 11, 38, 43, 57, 18, 12, 19, 41, 44, 57};

  scs_int Ap[] = {0,   2,   10,  14,  17,  22,  26,  27,  31,  35,  42,
                  43,  48,  49,  52,  55,  56,  58,  64,  66,  71,  75,
                  78,  80,  85,  86,  88,  91,  92,  94,  98,  101, 102,
                  106, 109, 109, 111, 116, 119, 124, 130, 133, 135, 137,
                  140, 142, 143, 146, 147, 148, 150, 151, 155, 157, 164,
                  167, 170, 174, 175, 179, 180};

  scs_float b[] = {-0.1, -0.2, -0.8, 0.7,  0.4,  -0.7, -0.1, 1.2,  -1,   -0.6,
                   -0.5, 2.6,  0.3,  0.4,  0.6,  0.8,  0.5,  1.5,  0,    0.3,
                   -0.3, -0.7, 1.7,  0.7,  -2.3, -2,   0.5,  1.7,  0.6,  -0.9,
                   -1,   2.4,  0.7,  -1.9, 0,    -0.1, -1.4, 0,    0.6,  0.2,
                   0.4,  -2.6, 1.3,  0.5,  -0.6, -0.9, -0.9, 0.9,  -0.8, -0.1,
                   0,    -0.2, 0.1,  -0.7, -0.2, -1.7, 0.8,  -0.4, -0.9, -0.2};

  scs_float c[] = {1.2,  -0.2, -0.4, 1.2,  -0.2, -1.2, -0.1, -0.5, 1.2,  0.2,
                   -0.8, 0.3,  -1.6, 1.6,  0.8,  -0.4, 0.1,  1.8,  0.4,  1.1,
                   0.2,  1.2,  -0.4, -0.6, 1.7,  -0.6, -1,   -0.5, 0.6,  1.2,
                   2.1,  1.6,  0.6,  1.3,  -1,   -0.8, -0.8, -0.2, -0.9, 1,
                   0.7,  -2,   -0.6, -0.5, 0.9,  -0.3, -2.1, -0,   -0.5, 0.1,
                   -0.3, 0.8,  2,    0.8,  0.5,  0.8,  -0.3, -0,   -1.1, 0.2};

  scs_int m = 60;
  scs_int n = 60;
  scs_int s[] = {3, 4};
  scs_int sssize = 2;
  scs_int cs[] = {5, 4};
  scs_int cssize = 2;
  k->z = 1;
  k->l = 2;
  k->s = s;
  k->ssize = sssize;
  k->cs = cs;
  k->cssize = cssize;

  /* computed by SCS with high precision, not confirmed that this is optimal */
  scs_float opt = -135.009872;
  /* end data */

  d->m = m;
  d->n = n;
  d->b = b;
  d->c = c;

  d->P = (ScsMatrix *)scs_calloc(1, sizeof(ScsMatrix));
  d->P->m = n;
  d->P->n = n;
  d->P->x = Px;
  d->P->i = Pi;
  d->P->p = Pp;

  d->A = (ScsMatrix *)scs_calloc(1, sizeof(ScsMatrix));
  d->A->m = m;
  d->A->n = n;
  d->A->x = Ax;
  d->A->i = Ai;
  d->A->p = Ap;

  scs_set_default_settings(stgs);
  stgs->eps_abs = 1e-7;
  stgs->eps_rel = 1e-7;
  stgs->eps_infeas = 1e-9;

  exitflag = scs(d, k, stgs, sol, &info);

  perr = info.pobj - opt;
  derr = info.dobj - opt;

  scs_printf("primal obj error %4e\n", perr);
  scs_printf("dual obj error %4e\n", derr);

  success = ABS(perr) < 1e-4 && ABS(derr) < 1e-4 && exitflag == SCS_SOLVED;

  mu_assert("sd_and_complex_sd: SCS failed to produce outputflag SCS_SOLVED",
            success);

  fail = verify_solution_correct(d, k, stgs, &info, sol, exitflag);
  if (fail)
    return fail;

  /* kill data */
  scs_free(d->A);
  scs_free(d->P);
  scs_free(k);
  scs_free(stgs);
  scs_free(d);
  SCS(free_sol)(sol);

  return fail;
}
