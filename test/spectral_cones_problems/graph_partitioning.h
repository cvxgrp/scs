#include "glbopts.h"
#include "linalg.h"
#include "minunit.h"
#include "problem_utils.h"
#include "rw.h"
#include "scs.h"
#include "scs_matrix.h"
#include "util.h"

// for SpectralSCS
static const char *graph_partitioning(void) {
  ScsCone *k = (ScsCone *)scs_calloc(1, sizeof(ScsCone));
  ScsData *d = (ScsData *)scs_calloc(1, sizeof(ScsData));
  ScsSettings *stgs = (ScsSettings *)scs_calloc(1, sizeof(ScsSettings));
  ScsSolution *sol = (ScsSolution *)scs_calloc(1, sizeof(ScsSolution));
  ScsInfo info = {0};
  scs_int exitflag;
  scs_float perr, derr;
  scs_int success;
  const char *fail;

  /* data */
  scs_float Ax[] = {-1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1.,
                    -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1.,
                    -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1.,
                    -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1.,
                    -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1.,
                    -1., 1., -1., 1., -1., 1., -1., 1., -1., 1., -1., 1.,
                    -1., 1., -1., 1., -1., 1., -1., 1., -1.};
  scs_int Ai[] = {1,   0, 2,   0, 42,  0, 81,  0, 119, 0, 156, 0, 192, 0,
                  227, 0, 261, 0, 294, 0, 326, 0, 357, 0, 387, 0, 416, 0,
                  444, 0, 471, 0, 497, 0, 522, 0, 546, 0, 569, 0, 591, 0,
                  612, 0, 632, 0, 651, 0, 669, 0, 686, 0, 702, 0, 717, 0,
                  731, 0, 744, 0, 756, 0, 767, 0, 777, 0, 786, 0, 794, 0,
                  801, 0, 807, 0, 812, 0, 816, 0, 819, 0, 821};
  scs_int Ap[] = {0,  1,  3,  5,  7,  9,  11, 13, 15, 17, 19, 21, 23, 25,
                  27, 29, 31, 33, 35, 37, 39, 41, 43, 45, 47, 49, 51, 53,
                  55, 57, 59, 61, 63, 65, 67, 69, 71, 73, 75, 77, 79, 81};

  scs_float b[] = {
      0.,         0.,         -1.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        1.41421356, -0.,        -0.,        -0.,
      -1.,        -0.,        1.41421356, -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -1.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        1.41421356, -0.,        -6.,
      -0.,        -0.,        -0.,        1.41421356, -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        1.41421356, 1.41421356,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      1.41421356, -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        1.41421356, -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -2.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        1.41421356, -0.,        -0.,        1.41421356,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -2.,        -0.,        1.41421356, -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        1.41421356, -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -3.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      1.41421356, -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        1.41421356,
      1.41421356, -0.,        -0.,        -6.,        -0.,        -0.,
      -0.,        1.41421356, -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      1.41421356, -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        1.41421356, -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        1.41421356, -0.,
      -1.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        1.41421356, -0.,        -0.,
      -0.,        -0.,        -1.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        1.41421356, -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -3.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        1.41421356, -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      1.41421356, -0.,        1.41421356, -2.,        1.41421356, -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -3.,        1.41421356, -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        1.41421356, -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -4.,        1.41421356, -0.,        -0.,        1.41421356, -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -3.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        1.41421356, -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -5.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        1.41421356, -0.,
      -0.,        1.41421356, -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        1.41421356, -0.,        1.41421356, -0.,
      -2.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        1.41421356, -0.,        1.41421356,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -3.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        1.41421356, -0.,
      1.41421356, -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -2.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        1.41421356,
      -0.,        -0.,        1.41421356, -0.,        -0.,        -0.,
      -2.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        1.41421356, -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -1.,        -0.,        -0.,        -0.,
      -0.,        1.41421356, -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -2.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -2.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        1.41421356, -0.,        -0.,        1.41421356, -0.,
      -0.,        -0.,        -3.,        -0.,        -0.,        -0.,
      1.41421356, 1.41421356, -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -1.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -5.,        -0.,        -0.,
      -0.,        -0.,        -0.,        1.41421356, -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -2.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -4.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        1.41421356, -0.,        1.41421356, -0.,
      -4.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -2.,
      -0.,        -0.,        -0.,        -0.,        1.41421356, 1.41421356,
      -0.,        -0.,        -0.,        -1.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -0.,        -0.,        -0.,
      -3.,        -0.,        1.41421356, -0.,        -0.,        -0.,
      -0.,        1.41421356, -4.,        -0.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -1.,        -0.,        -0.,
      -0.,        -0.,        -0.,        -4.,        -0.,        -0.,
      -0.,        1.41421356, -7.,        -0.,        -0.,        -0.,
      -2.,        -0.,        -0.,        -4.,        -0.,        -3.};
  scs_float c[] = {1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
                   0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
                   0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.};

  scs_int m = 822;
  scs_int n = 41;

  scs_int z = 1;
  scs_int l = 0;
  scs_int *q = SCS_NULL;
  scs_int qsize = 0;
  scs_int *s = SCS_NULL;
  scs_int ssize = 0;
  scs_int ep = 0;
  scs_int ed = 0;
  scs_float *p = SCS_NULL;
  scs_int psize = 0;
  scs_int *d_array = SCS_NULL;
  scs_int dsize = 0;
  scs_int *nuc_m = SCS_NULL;
  scs_int *nuc_n = SCS_NULL;
  scs_int nucsize = 0;
  scs_int *ell1 = SCS_NULL;
  scs_int ell1_size = 0;
  scs_int sl_n[] = {40};
  scs_int sl_k[] = {3};
  scs_int sl_size = 1;

  // computed using mosek (the input of Ax is truncated, and mosek solved
  // the problem with the non-truncated data)
  scs_float opt = -0.7736762265822145;
  /* end data */

  d->m = m;
  d->n = n;
  d->b = b;
  d->c = c;

  d->A = (ScsMatrix *)scs_calloc(1, sizeof(ScsMatrix));

  d->A->m = m;
  d->A->n = n;
  d->A->x = Ax;
  d->A->i = Ai;
  d->A->p = Ap;

  k->z = z;
  k->l = l;
  k->q = q;
  k->qsize = qsize;
  k->s = s;
  k->ssize = ssize;
  k->ep = ep;
  k->ed = ed;
  k->p = p;
  k->psize = psize;
  k->d = d_array;
  k->dsize = dsize;
  k->nuc_m = nuc_m;
  k->nuc_n = nuc_n;
  k->nucsize = nucsize;
  k->ell1 = ell1;
  k->ell1_size = ell1_size;
  k->sl_n = sl_n;
  k->sl_k = sl_k;
  k->sl_size = sl_size;

  scs_set_default_settings(stgs);
  stgs->eps_abs = 1e-7;
  stgs->eps_rel = 1e-7;
  stgs->eps_infeas = 1e-9;

  exitflag = scs(d, k, stgs, sol, &info);

  perr = SCS(dot)(d->c, sol->x, d->n) - opt;
  derr = -SCS(dot)(d->b, sol->y, d->m) - opt;

  scs_printf("primal obj error %4e\n", perr);
  scs_printf("dual obj error %4e\n", derr);

  success = ABS(perr) < 1e-4 && ABS(derr) < 1e-4 && exitflag == SCS_SOLVED;

  mu_assert("graph partitioning: SCS failed to produce outputflag SCS_SOLVED",
            success);

  fail = verify_solution_correct(d, k, stgs, &info, sol, exitflag);
  if (fail)
    return fail;

  /* kill data */
  scs_free(d->A);
  scs_free(k);
  scs_free(stgs);
  scs_free(d);
  SCS(free_sol)(sol);

  return fail;
}
